---
title: "Final Project"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(reticulate)
knitr::knit_engines$set(py = function(options) {
  code <- paste(options$code, collapse = '\n')
  out  <- system2(
    'python', c('-c', shQuote(code)), stdout = TRUE
  )
  knitr::engine_output(options, code, out)
})
#py_install('pandas')
```

About COVID-19 Visualization 
===================================== 

Row {data-width=650}
-----------------------------------------------------------------------

### Chart A
This Final Project is about the covid-19 confirmed and death cases in the US and different States and the spread of the covid-19, especially in the white house recently events. Thereare are three datasets that were used in this project.

Row {data-height=350}
-----------------------------------------------------------------------
### 
1. Covid-19 confirmed cases in the use
  Data source: https://covidtracking.com/data/download
  
###
2. Covid-19 confirmed and deaths cases via States 
  Data source: COVID-19 Open Research Dataset Challenge (CORD-19)
  https://www.kaggle.com/allen-institute-for-ai/CORD-19-research-challenge
  
###
3. Covid-19 white house spread, dataset used are after python cleaned, 
  individuals who were with President Trump prior to the announcement of his positive COVID test.
  Data source: https://www.kaggle.com/theogoe/white-house-covid-spread


Covid-19 Cases Visualization
===================================== 

Column
-----------------------------------------------------------------------

### Time series plot of the U.S. Covid-19 test results in 2020 (positive/negative cases)

```{r}
library(tidyverse) 
library(readr)
library(plyr)
library(ggplot2)

df <- read_csv(file = 'national-history.csv')
ggplot(data=df)+
  geom_line(mapping=aes(y=negative, x= date,color="negative")) +
  scale_y_continuous(labels = paste0(df$negative, "M"),
                     breaks = 10^6 * df$negative)+ 
  geom_line(mapping=aes(y=positive, x= date,color="positive")) + 
  scale_y_continuous(labels = paste0(df$positive, "M"),
                     breaks = 10^6 * df$positive)+
  scale_color_manual(values = c(
    'negative' = 'darkblue',
    'positive' = 'red')) +
  labs(color = 'Total test resutls') + ggtitle("The U.S. Covid-19 test results in 2020") 
  


```

### The U.S. confirmed cases states level in 2020
```{r}

library(ggplot2)
library(scales)
df <- read_csv(file = 'covid_us.csv')
cases_by_state <- aggregate(cases ~ state, data = df, FUN = sum)
cases_by_state <- cases_by_state[order(cases_by_state$cases, decreasing = TRUE),]
ggplot(cases_by_state, aes(x = cases, y = reorder(state, cases)), fill="#FF6666") + 
  scale_x_continuous(labels = comma) + 
  xlab("covid-19 confirmed cases by state") + ylab("states") + 
    geom_bar(stat = 'identity') +theme_minimal()

```


Column
-----------------------------------------------------------------------

### The U.S. death Increases and hospitalizedCurrently in 2020

```{r}
df <- read_csv(file = 'national-history.csv')
ggplot(data=df)+
  geom_line(mapping=aes(y=deathIncrease, x= date,color="deathIncrease")) +
  #scale_y_continuous(labels = paste0(df$deathIncrease, "M"),
                     #breaks = 10^6 * df$deathIncrease)+ 
  geom_line(mapping=aes(y=hospitalizedCurrently, x= date,color="hospitalizedCurrently")) + 
  #scale_y_continuous(labels = paste0(df$hospitalizedCurrently, "M"),
                     #breaks = 10^6 * df$hospitalizedCurrently)+
  scale_color_manual(values = c(
    'deathIncrease' = 'darkblue',
    'hospitalizedCurrently' = 'red')) +
  labs(color = 'Total test resutls') + ggtitle("The U.S. death Increases and hospitalizedCurrently in 2020")

#coord_flip()

```

### The U.S. deaths cases states level in 2020

```{r}
df <- read_csv(file = 'covid_us.csv')
deaths_by_state <- aggregate(deaths ~ state, data = df, FUN = sum)
deaths_by_state <- deaths_by_state[order(deaths_by_state$deaths, decreasing = TRUE),]
ggplot(deaths_by_state, aes(x = deaths, y = reorder(state, deaths)))+
  scale_x_continuous(labels = comma) +
  xlab("covid-19 deaths by state") + ylab("states") + 
    geom_bar(stat = 'identity') +theme_minimal()
```


Covid-19 Spread Visualization
===================================== 

Row
-----------------------------------------------------------------------

```{py}
import pandas as pd
import xlrd
import matplotlib.pyplot as plt
from ast import literal_eval
import itertools
from matplotlib.pyplot import figure
def create_source_target(combination):
    return pd.Series([list(combination)[0], list(combination)[1]])

events = pd.read_excel('/Users/clara/Downloads/503/finalProj/events.xlsx')
names = pd.read_excel('/Users/clara/Downloads/503/finalProj/names.xlsx')
events['ppl'] = events['ppl'].apply(lambda x: literal_eval(x))
events['combination'] = events['ppl'].apply(lambda x: list(itertools.combinations(x, 2)))
events_combination= events.explode('combination')
events_combination[['source_abb', 'target_abb']] = events_combination['combination'].apply(create_source_target)
events_combination = pd.merge(events_combination, names, how='left',
                              left_on='source_abb', right_on='abbrev')
events_combination = pd.merge(events_combination, names, how='left',
                              left_on='target_abb', right_on='abbrev')
rename_rule = {'name_x': 'source', 'name_y': 'target'}
events_combination.rename(columns=rename_rule,inplace=True)
events_combination['weight'] = 1
events_combination.to_csv('edges1.csv')
events_combination['counts'] = events_combination.groupby(['source', 'target'])['weight'].transform('count')
events_combination = events_combination.reset_index()
events_combination = events_combination.drop([ 'date', 'event', 
    'source_abb', 'target_abb', 'ppl', 'combination', 'abbrev_x', 'abbrev_y', ], axis=1)
 #=events_combination.sort(['counts'], ascending=False)

df_final = events_combination.sort_values(by=['counts'], ascending=False)
df_final.to_csv (r'network.csv', index = False, header=True)
```


### White house events spread 
```{r}
library(readr)
library(tidyverse)
library(network)
viz_df <- read_csv(file = 'network.csv') %>%  drop_na()
# get nodes
sources <- viz_df %>% distinct(source) %>% plyr::rename(c("source"="label"))
destinations <- viz_df %>% distinct(target) %>% plyr::rename(c("target"="label"))
nodes <- full_join(sources, destinations, by = "label")
nodes <- nodes %>%  drop_na() %>% rowid_to_column("id")

per_route <- viz_df 
edges <- per_route %>% 
  left_join(nodes, by = c("source" = "label")) %>% 
  plyr::rename(c("id"="from"))
# get edges
edges <- edges %>% 
  left_join(nodes, by = c("target" = "label")) %>% 
  plyr::rename(c("id"="to"))
edges <- select(edges, from, to, counts) %>%  drop_na()
routes_network <- network(edges, vertex.attr = nodes, matrix.type = "edgelist", ignore.eval = TRUE)
plot(routes_network, vertex.cex = 3)

```


### White house events spread for Donald Trump tracing
```{r}
viz_df <- read_csv(file = 'network.csv') %>%  drop_na()
df_first_35 <- viz_df[1:35, ]
sources35 <- df_first_35 %>%
  distinct(source) %>%
  plyr::rename(c("source"="label"))
#distinct(select(df, source))

destinations35 <- df_first_35 %>%
  distinct(target) %>%
  plyr::rename(c("target"="label"))

nodes35 <- full_join(sources35, destinations35, by = "label")
nodes35 <- nodes35 %>% rowid_to_column("id")
per_route35 <- df_first_35
edges35 <- per_route35 %>% 
  left_join(nodes35, by = c("source" = "label")) %>% 
  plyr::rename(c("id"="from"))

edges35 <- edges35 %>% 
  left_join(nodes35, by = c("target" = "label")) %>% 
  plyr::rename(c("id"="to"))
edges35 <- select(edges35, from, to, counts)

detach(package:network)
rm(routes_network)
library(igraph)
routes_igraph <- graph_from_data_frame(d = edges35, vertices = nodes35, directed = TRUE)
plot(routes_igraph, edge.arrow.size = 0.2)

```


Row
-----------------------------------------------------------------------

### White house events spread for Donald Trump tracing
```{r}
plot(routes_igraph, layout = layout_with_graphopt, edge.arrow.size = 0.2)
```

### Would Cloud for White house events spread onald Trump tracing
```{r}
# Load
library("tm")
library("SnowballC")
library("wordcloud")
library("RColorBrewer")

df <- read_csv(file = 'network.csv')
x <- as.vector(as.matrix(df[,c("source", "target")]))
set.seed(1234)
wordcloud(words = x, min.freq = 1,
          max.words=200, random.order=FALSE, rot.per=0.35, 
          colors=brewer.pal(8, "Dark2"))
```

